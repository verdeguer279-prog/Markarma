<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GAD - Gestión de Cursos y Pagos</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"> 
  <style>
    :root {
      --bg-dark: #1a1a2e;
      --card-bg: #282844; /* Fondo para el card del formulario */
      --text-light: #e9e9f0;
      --accent-blue: #667eea;
      --accent-purple: #764ba2;
      --accent-gradient: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
      --accent-red: #dc3545;
      --accent-green: #28a745;
      --accent-orange: #ff9800;
      --header-bg: #3e3e5c; /* Usado para la cabecera de tabla y card de stats */
    }
    body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg,#667eea,#764ba2); color: var(--text-light); margin:0; }
    .container { max-width:1400px; margin:30px auto; padding:0 16px; }
    h1 { text-align:center; margin-bottom:20px; font-size:2.2rem; font-weight:700; color:#fff; }
    /* Card principal: un poco más transparente */
    .card { background-color: rgba(0,0,0,0.55); border-radius:12px; padding:25px; margin-bottom:25px; box-shadow:0 6px 16px rgba(0,0,0,0.3); }

    /* Controles de botones */
    .toggle-form-container { 
        text-align:center; 
        margin-bottom:15px; 
        display: flex; 
        justify-content: center; 
        gap: 15px;
    }

    #btnToggleForm, #btnMainMenu { padding:12px 24px; font-size:1rem; border:none; border-radius:8px; cursor:pointer; font-weight:600;
      transition:0.3s; }

    #btnToggleForm {
        background-image: var(--accent-gradient); 
        color: var(--text-light);
    }
    #btnToggleForm:hover { transform:scale(1.05); }

    #btnMainMenu {
        background-color: var(--accent-orange); 
        color: #333; 
    }
    #btnMainMenu:hover { transform:scale(1.05); }

    /* --- FORMULARIO AHORA ES UN MODAL --- */
    #data-entry-form { 
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.85); /* Fondo oscuro semitransparente */
        align-items: center;
        justify-content: center;
        z-index: 1001; /* Z-index alto para superponer */
        display: none; 
        opacity: 0; 
        transition: opacity .3s ease; 
    }
    #data-entry-form.visible { 
        display: flex; /* Usamos flex para centrar */
        opacity: 1; 
    }
    /* Contenido del modal */
    .modal-content-wrapper {
        background-color: var(--card-bg);
        border-radius: 12px;
        padding: 30px; 
        max-width: 900px;
        width: 90%;
        max-height: 95vh; 
        overflow-y: auto; /* Scroll interno si es necesario */
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        transform: scale(0.95);
        transition: transform .3s ease;
        position: relative; /* REQ: Necesario para posicionar el mensaje de estado absoluto */
    }
    #data-entry-form.visible .modal-content-wrapper {
        transform: scale(1);
    }

    /* Estilos para el contenedor de mensajes de estado (Posicionamiento Absoluto) */
    #statusMessageContainer {
        position: absolute; /* Posicionamiento absoluto para no alterar el tamaño del modal */
        top: 80px; /* Colocarlo debajo del título */
        left: 50%;
        transform: translateX(-50%);
        width: 85%; /* Ancho fijo para centrarlo */
        z-index: 1010; 
        
        /* Estilos de mensaje */
        padding: 10px; 
        border-radius: 6px; 
        text-align: center; 
        font-weight: 600; 
        display: none; /* Por defecto oculto */
        transition: opacity 0.3s ease;
    }

    #data-entry-form h2 { color:#ffd54f; margin-bottom:15px; }
    .form-grid { 
        display:grid; 
        grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); 
        gap: 28px; 
        margin-bottom: 20px;
    } 
    .form-group { 
        display:flex; 
        flex-direction:column; 
        margin-bottom: 8px; 
    }
    .form-group label { font-weight:600; margin-bottom:6px; color:var(--text-light); }
    
    /* Campos de input en el formulario superior */
    #data-entry-form input:not([type="checkbox"]), #data-entry-form select, #data-entry-form textarea {
      padding:10px; border-radius:6px; border:1px solid #ccc;
      background-color: #fff; 
      color: #333; 
      width: 100%; 
    }
    /* Estilo específico para el campo calculado de solo lectura */
    #importeNetoCobrado {
        background-color: #f7e096;
        color: #333;
        font-weight: 700;
        border: 2px solid #ff9800;
    }
    /* Estilos para los NUEVOS campos calculados de precio/hora */
    #precioHoraBruto {
        background-color: #f0f0f0;
        color: #333;
    }
    #importeHoraNeto {
        background-color: #e0f7fa;
        color: #333;
        font-weight: 600;
    }

    #data-entry-form input:focus, #data-entry-form select:focus, #data-entry-form textarea:focus {
        border-color: var(--accent-blue);
        outline: none;
        box-shadow: 0 0 5px rgba(102, 126, 234, 0.5);
    }
    textarea { min-height:80px; resize:vertical; }
    
    /* Controles de Acción y Navegación */
    .form-actions { 
        grid-column:1/-1; 
        display:flex; 
        gap:12px; 
        margin-top:15px; 
        justify-content: flex-end; /* Alinear los botones de Guardar/Cerrar a la derecha */
    }
    #btnSubmitCourse, #btnCancelEdit { padding:10px 20px; font-weight:600; border:none; border-radius:8px; cursor:pointer; }
    #btnSubmitCourse { background-image: var(--accent-gradient); color:#fff; flex-grow:0; }
    #btnCancelEdit { background-color: var(--accent-red); color:#fff; }

    /* Estilo para los botones de navegación */
    .nav-actions {
        display: flex;
        justify-content: space-between;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid rgba(255,255,255,0.1);
    }
    .nav-actions button {
        padding: 8px 15px;
        font-weight: 600;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        background-color: var(--accent-blue);
        color: #fff;
        transition: background-color 0.2s;
    }
    .nav-actions button:hover:not(:disabled) {
        background-color: #556ee4;
    }
    .nav-actions button:disabled {
        background-color: #4e4e6d;
        cursor: not-allowed;
        opacity: 0.6;
    }
    
    /* Stats Card (Desglose de Ingresos) */
    #stats-card { 
        background-color: var(--header-bg); 
        padding: 20px 25px; 
        border: 1px solid rgba(255,255,255,0.1); 
    }
    #stats-card h2 { color: #fff; margin-bottom: 15px; }
    
    .stats-controls { 
        display: flex; 
        gap: 30px; 
        margin-bottom: 20px; 
        flex-wrap: wrap;
    }
    .stats-controls .form-group { 
        min-width: 350px; 
        flex-grow: 1; 
    }
    
    /* REQ Alineación: Estructura de alineación forzada para Pagador y Año */
    .stats-controls select {
        width: 100%;
        min-width: 150px; 
        padding: 8px;
        border-radius: 6px;
        background-color: #fff;
        color: #333;
        height: 38px; /* Altura forzada para que coincida con el botón */
    }
    
    /* Estilos para el nuevo botón de limpiar pagadores */
    #btnCleanPagadores {
        background-color: var(--accent-orange); 
        color: #333;
        padding: 6px 10px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: background-color 0.2s;
        font-size: 0.9rem;
        line-height: 1.2;
        height: 38px; /* Altura forzada para que coincida con el select */
    }
    #btnCleanPagadores:hover {
        background-color: #e68900;
    }

    /* Contenedor que alinea el select y el botón del Pagador */
    .pagador-filter-row {
        display: flex;
        align-items: flex-end; /* Alinea los ítems en la parte inferior */
        gap: 10px;
    }
    .pagador-filter-row select {
        flex-grow: 1; 
    }


    .stats-results { 
        display: flex; 
        gap: 50px; 
        padding-top: 15px; 
        border-top: 1px solid rgba(255,255,255,0.1);
        flex-wrap: wrap;
    }
    .stats-results p { margin: 0; font-size: 1.1rem; }
    .stats-results strong { color: #ffd54f; font-weight: 700; }
    #totalImporte, #totalHoras { font-weight: 700; }
    
    /* NUEVO: Listado Header (Alineación) */
    .listado-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    .listado-header h2 {
        margin: 0;
    }

    /* Exportar a Excel */
    #btnExportExcel {
        background-color: var(--accent-green); 
        color: white; 
        padding: 10px 20px; 
        border: none; 
        border-radius: 8px; 
        cursor: pointer; 
        font-weight: 600;
    }
    
    /* Tabla */
    .courses-table { width:100%; border-collapse:collapse; font-size:.95em; table-layout: fixed; } 
    .courses-table th, .courses-table td { padding:10px 6px; border-bottom:1px solid rgba(255,255,255,0.1); vertical-align: middle; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .courses-table th { background-color: var(--header-bg); color:#ffd54f; text-transform:uppercase; }
    .action-btns { display:flex; gap:8px; }
    
    /* Estilos de botones de acción para que se vean bien */
    .action-btns button {
        background: var(--accent-blue);
        color: #fff;
        border: none;
        padding: 4px 8px;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.2s;
        line-height: 1; /* Asegura que el icono esté centrado */
        font-size: 1rem; /* Asegura el tamaño del icono */
    }
    /* Estilo para el botón de editar */
    .edit-btn { background-color: #4caf50; } 
    /* Estilo para el botón de eliminar */
    .delete-btn { background-color: #f44336; }
    /* Estilo para el botón de observaciones */
    .obs-btn { background-color: #2196f3; }
    
    /* REQ: Estilo para el botón de alerta (Ojo Rojo) */
    .obs-btn.alert {
        background-color: var(--accent-red); /* Fondo Rojo */
        color: white;
        border: 2px solid var(--accent-orange); /* Borde Naranja para destacarse */
    }
    
    .action-btns button:hover {
        opacity: 0.8;
    }
    
    /* REQUERIMIENTO: Definición de anchos de columna corregida */
    .courses-table th:nth-child(1), .courses-table td:nth-child(1) { width: 4%; } /* # */
    .courses-table th:nth-child(2), .courses-table td:nth-child(2) { width: 9%; } /* Inicio */
    .courses-table th:nth-child(3), .courses-table td:nth-child(3) { width: 9%; } /* Fin */
    .courses-table th:nth-child(4), .courses-table td:nth-child(4) { width: 15%; } /* Pagador - REDUCIDO */
    .courses-table th:nth-child(5), .courses-table td:nth-child(5) { width: 15%; } /* Lugar - AUMENTADO */
    .courses-table th:nth-child(6), .courses-table td:nth-child(6) { width: 6%; } /* Horas */
    .courses-table th:nth-child(7), .courses-table td:nth-child(7) { width: 8%; } /* Importe (Neto) */
    .courses-table th:nth-child(8), .courses-table td:nth-child(8) { width: 7%; } /* Pago (Pendiente/Cobrado) */
    .courses-table th:nth-child(9), .courses-table td:nth-child(9) { width: 7%; } /* Cobrado (Fecha) - REDUCIDO */
    .courses-table th:nth-child(10), .courses-table td:nth-child(10) { width: 6%; } /* Renta */
    .courses-table th:nth-child(11), .courses-table td:nth-child(11) { width: 14%; } /* Acciones */

    /* Las fechas NO se cortan (cells 2 y 3) */
    .courses-table td:nth-child(2), .courses-table td:nth-child(3) {
        white-space: nowrap; 
        overflow: visible; 
        text-overflow: clip;
        padding: 10px 4px; /* Reducir padding para más espacio */
    }
    /* Aseguramos que el contenido de cobrado (Fecha Cobro, cell 9) se corte si es necesario */
    .courses-table td:nth-child(9) {
        white-space: nowrap; 
        overflow: hidden; 
        text-overflow: ellipsis;
        padding: 10px 4px; 
    }


    /* Pago */
    .status-cobrado { color: var(--accent-green); font-weight:700; }
    .status-pendiente { color: var(--accent-red); font-weight:700; }

    /* Modal observaciones */
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); align-items:center; justify-content:center; z-index:1000; }
    .modal-content { background:#fff; color:#333; padding:20px; border-radius:10px; max-width:500px; width:90%; }
    .close-modal { float:right; background:var(--accent-red); color:#fff; border:none; border-radius:4px; padding:4px 10px; cursor:pointer; }
  
    /* Ajuste columna de Acciones */
    .courses-table th:nth-child(11),
    .courses-table td:nth-child(11) {
        width: 14%;
        min-width: 140px;   /* Evita que se haga demasiado estrecha */
        white-space: nowrap;
    }

    /* Botones de acción */
    .action-btns {
        display: flex;
        gap: 8px;
        flex-wrap: nowrap;   /* No deja que los botones salten de línea */
        justify-content: center; /* Centra los botones en la celda */
    }

</style>
</head>
<body>
<div class="container">
  <h1><i class="fas fa-graduation-cap"></i> Control de Cursos</h1>

  <div class="toggle-form-container">
    <button id="btnMainMenu" onclick="window.location.href='index.html'">
        <i class="fas fa-home"></i> Menú Principal
    </button>
    <button id="btnToggleForm"><i class="fas fa-plus-circle"></i> Añadir Nuevo Curso</button>
  </div>

  <div id="data-entry-form">
    <div class="modal-content-wrapper">
        <h2><i class="fas fa-edit"></i> <span id="formTitle">Agregar Curso</span></h2>
        <div id="statusMessageContainer"></div>

        <form id="courseForm">
        <input type="hidden" id="courseKey" value="">
        <div class="form-grid">
            <div class="form-group"><label for="inicio">Fecha Inicio</label><input type="date" id="inicio" required></div>
            <div class="form-group"><label for="fin">Fecha Fin</label><input type="date" id="fin" required></div>
            <div class="form-group">
                <label for="pagador">Pagador</label>
                <input type="text" id="pagador" list="pagadoresListForm" required>
                <datalist id="pagadoresListForm"></datalist>
            </div> 
            <div class="form-group"><label for="horas">Horas</label><input type="number" step="0.01" id="horas" required oninput="calculateNeto()"></div>
            
            <div class="form-group"><label for="importeBruto">Importe Bruto (€)</label><input type="number" step="0.01" id="importeBruto" required oninput="calculateNeto()"></div>
            <div class="form-group"><label for="irpf">IRPF (%)</label><input type="number" step="0.01" id="irpf" value="0" oninput="calculateNeto()"></div>
            <div class="form-group">
                <label for="importeNetoCobrado">Total Cobrado (Neto €)</label>
                <input type="number" step="0.01" id="importeNetoCobrado" readonly value="0.00">
            </div>
            
            <div class="form-group">
                <label for="cobrado">Pago</label>
                <select id="cobrado">
                <option value="PENDIENTE">PENDIENTE</option>
                <option value="COBRADO">COBRADO</option>
                </select>
            </div>
            <div class="form-group"><label for="fechaCobro">Detalle/Fecha Cobro</label><input type="text" id="fechaCobro"></div>
            <div class="form-group"><label for="renta">Año Renta</label><input type="number" id="renta"></div>

            <div class="form-group">
                <label for="precioHoraBruto">Precio Hora (Bruto €)</label>
                <input type="number" step="0.01" id="precioHoraBruto" readonly value="0.00">
            </div>
            <div class="form-group">
                <label for="importeHoraNeto">Importe Hora (Neto €)</label>
                <input type="number" step="0.01" id="importeHoraNeto" readonly value="0.00">
            </div>
            <div class="form-group"><label for="lugarCelebracion">Lugar de Celebración</label><input type="text" id="lugarCelebracion"></div>
            <div class="form-group"><label for="horario">Horario</label><input type="text" id="horario"></div>
            <div class="form-group"><label for="asistentes">Asistentes</label><input type="text" id="asistentes"></div>
            
            <div class="form-group" style="grid-column:1/-1;">
                <label for="observaciones">Observaciones</label><textarea id="observaciones"></textarea>
                <div style="display:flex; align-items:center; gap:10px; margin-top:10px;">
                    <input type="checkbox" id="alerta" style="width: 20px; height: 20px; flex-shrink: 0;">
                    <label for="alerta" style="margin-bottom:0; font-weight:700;">Marcar como Alerta/Incidencia</label>
                </div>
            </div>
        </div>
        
        <div class="nav-actions">
            <button type="button" id="btnPrevCourse" onclick="navigateCourse(-1)" disabled><i class="fas fa-chevron-left"></i> Anterior</button>
            <div class="form-actions">
                <button type="submit" id="btnSubmitCourse">Guardar</button>
                <button type="button" id="btnCancelEdit" onclick="handleCancelEdit()"><i class="fas fa-times-circle"></i> Cerrar</button>
            </div>
            <button type="button" id="btnNextCourse" onclick="navigateCourse(1)" disabled>Siguiente <i class="fas fa-chevron-right"></i></button>
        </div>

        </form>
    </div>
  </div>
  
  <div class="card" id="stats-card">
    <h2><i class="fas fa-chart-line"></i> Desglose de Ingresos Cobrados</h2>
    <div class="stats-controls">
        <div class="form-group">
            <label for="filterInicioYear">Filtrar por Año Inicio:</label>
            <select id="filterInicioYear" onchange="renderStats()">
                <option value="">TODOS</option>
            </select>
        </div>
        
        <div class="form-group pagador-filter-group">
            <label for="filterPagador">Filtrar por Pagador:</label>
            <div class="pagador-filter-row">
                <select id="filterPagador" onchange="renderStats()">
                    <option value="">TODAS</option>
                </select>
                <button type="button" id="btnCleanPagadores" onclick="cleanUnusedPagadores()" title="Eliminar pagadores que no están asignados a ningún curso actual">
                    <i class="fas fa-broom"></i> Eliminar No Usados
                </button>
            </div>
        </div>
    </div>
    <div class="stats-results">
        <p><strong>Importe Total Cobrado (Neto):</strong> <span id="totalImporte">0.00 €</span></p>
        <p><strong>Total Horas Cobradas:</strong> <span id="totalHoras">0.00 h</span></p>
    </div>
  </div>

  <div class="card">
    <div class="listado-header">
        <h2><i class="fas fa-list"></i> Listado</h2>
        <button id="btnExportExcel" onclick="exportToExcel()">
            <i class="fas fa-file-excel"></i> Exportar a Excel
        </button>
    </div>
    
    <table class="courses-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Inicio</th>
          <th>Fin</th>
          <th>Pagador</th>
          <th>Lugar</th> 
          <th>Horas</th>
          <th>Importe</th> 
          <th>Pago</th> 
          <th>Cobrado</th>
          <th>Renta</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="coursesTableBody">
        <tr><td colspan="11" style="text-align:center;">Cargando...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<div id="obsModal" class="modal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeObsModal()">X</button>
    <h3>Detalles Adicionales del Curso</h3>
    <p id="obsText"></p>
  </div>
</div>

<script>
// La ruta de la base de datos se mantiene
const BASE = "https://markarma279-default-rtdb.europe-west1.firebasedatabase.app/FORMACION";
const COMPANIES_PATH = "EMPRESAS"; 

const tbody = document.getElementById('coursesTableBody');
const formModal = document.getElementById('data-entry-form'); 
const btnToggleForm = document.getElementById('btnToggleForm');
const form = document.getElementById('courseForm');
const statusMessageContainer = document.getElementById('statusMessageContainer');
// Elemento del campo oculto (clave de edición)
const courseKeyInput = document.getElementById('courseKey'); 


const filterInicioYear = document.getElementById('filterInicioYear');
const filterPagador = document.getElementById('filterPagador');
const btnExportExcel = document.getElementById('btnExportExcel');
const btnPrevCourse = document.getElementById('btnPrevCourse'); 
const btnNextCourse = document.getElementById('btnNextCourse'); 

let editingKey = null; 
let courses = [];
let masterCompanies = []; 
let initialFormData = {}; 
let isSaveSuccess = false; 
let successTimeout = null; 


// Elementos del formulario
const inicio = document.getElementById('inicio');
const fin = document.getElementById('fin');
const pagador = document.getElementById('pagador'); 
const horas = document.getElementById('horas');
const importeBruto = document.getElementById('importeBruto');
const irpf = document.getElementById('irpf');
const importeNetoCobrado = document.getElementById('importeNetoCobrado'); 
const cobrado = document.getElementById('cobrado');
const fechaCobro = document.getElementById('fechaCobro');
const renta = document.getElementById('renta');
const observaciones = document.getElementById('observaciones');
const lugarCelebracion = document.getElementById('lugarCelebracion');
const horario = document.getElementById('horario');
const asistentes = document.getElementById('asistentes');
const precioHoraBruto = document.getElementById('precioHoraBruto'); 
const importeHoraNeto = document.getElementById('importeHoraNeto'); 
const alerta = document.getElementById('alerta'); 


// --- Lógica de Cálculo de Neto y Precio/Hora ---
function calculateNeto() {
    const bruto = parseFloat(importeBruto.value) || 0;
    const irpfPerc = parseFloat(irpf.value) || 0;
    const h = parseFloat(horas.value) || 0; 
    
    let neto = 0;
    let precioHBruto = 0;
    let precioHNeto = 0;

    if (bruto > 0) {
        const retencion = bruto * (irpfPerc / 100);
        neto = bruto - retencion;
    }
    
    if (h > 0) {
        precioHBruto = bruto / h;
        precioHNeto = neto / h;
    }

    importeNetoCobrado.value = neto.toFixed(2);
    precioHoraBruto.value = precioHBruto.toFixed(2);
    importeHoraNeto.value = precioHNeto.toFixed(2);
}
window.calculateNeto = calculateNeto;

// Obtener los datos del formulario de forma consistente para comparación
function getFormData() {
    calculateNeto(); 
    return {
        inicio: inicio.value,
        fin: fin.value,
        pagador: pagador.value, 
        horas: horas.value, 
        importeBruto: importeBruto.value, 
        irpf: irpf.value,
        importeNeto: importeNetoCobrado.value, 
        cobrado: cobrado.value, 
        fechaCobro: fechaCobro.value,
        renta: renta.value, 
        observaciones: observaciones.value,
        lugarCelebracion: lugarCelebracion.value,
        horario: horario.value,
        asistentes: asistentes.value,
        alerta: alerta.checked 
    };
}


// --- Lógica para mostrar mensajes de estado ---
function displayStatus(message, type) {
    statusMessageContainer.textContent = message;
    
    // Aplicar estilos según el tipo
    if (type === "success") { // Verde
        statusMessageContainer.style.backgroundColor = '#d4edda'; 
        statusMessageContainer.style.color = '#155724'; 
        statusMessageContainer.style.border = '1px solid #c3e6cb';
    } else if (type === "warning") { // Rojo
        statusMessageContainer.style.backgroundColor = '#f8d7da'; 
        statusMessageContainer.style.color = '#721c24'; 
        statusMessageContainer.style.border = '1px solid #f5c6cb';
    }
    statusMessageContainer.style.display = 'block';
}

function clearStatus() {
    statusMessageContainer.style.display = 'none';
    statusMessageContainer.textContent = '';
    statusMessageContainer.style.backgroundColor = 'transparent';
    statusMessageContainer.style.color = 'inherit';
    statusMessageContainer.style.border = 'none';
}


// --- Funciones para el Modal ---
function closeFormModal() {
    editingKey = null; // Reseteamos la clave global
    courseKeyInput.value = ''; // Reseteamos el campo oculto
    form.reset(); 
    importeNetoCobrado.value = (0).toFixed(2);
    precioHoraBruto.value = (0).toFixed(2); 
    importeHoraNeto.value = (0).toFixed(2); 
    formModal.classList.remove('visible'); 
    clearStatus(); 
    
    // Limpiar el timeout si existe
    if (successTimeout) { 
        clearTimeout(successTimeout);
        successTimeout = null;
    }
    isSaveSuccess = false; // Resetear el flag al cerrar
}
window.closeFormModal = closeFormModal; 

// Función para manejar el cierre del modal en modo edición
window.handleCancelEdit = () => {
    // Usamos courseKeyInput.value en lugar de editingKey por si se perdió el estado global
    const currentKey = courseKeyInput.value; 

    if (!currentKey) { // Modo Añadir (clave vacía)
        closeFormModal();
        return;
    }

    if (isSaveSuccess) {
        // Si ya se ha guardado con éxito (mensaje verde visible), cerramos inmediatamente y cancelamos el auto-cierre
        closeFormModal(); 
        return;
    }

    const currentData = getFormData();
    // Comparar con el estado inicial (guardado o al abrir la edición)
    const changed = JSON.stringify(currentData) !== JSON.stringify(initialFormData); 

    if (changed) {
        // Si hay cambios reales sin guardar, preguntar con confirm()
        if (confirm("Hay cambios sin guardar. ¿Cerrar de todos modos?")) {
            closeFormModal();
        }
    } else {
        // Mostrar mensaje de no cambio en rojo y cerrar con un delay (1.5s)
        displayStatus("No se efectuó ningún cambio.", "warning");
        // Usamos setTimeout sin la variable global ya que solo se ejecuta aquí
        setTimeout(closeFormModal, 1500); 
    }
};
window.handleCancelEdit = handleCancelEdit; 


function resetFormForAdd() {
    closeFormModal(); // Garantizar limpieza total (editingKey y courseKeyInput se resetean aquí)
    document.getElementById('formTitle').textContent = 'Agregar Curso';
    document.getElementById('btnSubmitCourse').textContent = 'Guardar';
    document.getElementById('btnCancelEdit').style.display = 'inline-block';
    
    // Ocultar botones de navegación al añadir
    btnPrevCourse.style.display = 'none';
    btnNextCourse.style.display = 'none';

    // Mostrar modal
    formModal.classList.add('visible');
}

// Event Listener para el botón de Añadir
btnToggleForm.onclick = resetFormForAdd;


// --- Firebase helpers ---
const url = (path="") => `${BASE}${path}.json`;
const urlCompanies = (path="") => `https://markarma279-default-rtdb.europe-west1.firebasedatabase.app/${COMPANIES_PATH}${path}.json`;
const GET = async(path="")=> (await fetch(url(path))).json();
const GET_COMPANIES = async()=> (await fetch(urlCompanies())).json();
const POST = async obj => (await fetch(url(),{method:"POST",body:JSON.stringify(obj)})).json();
const PUT = async (id,obj)=> (await fetch(url("/"+id),{method:"PUT",body:JSON.stringify(obj)})).json();
const DEL = async id=> (await fetch(url("/"+id),{method:"DELETE"})).json();
const PUT_COMPANIES = async list => (await fetch(urlCompanies(),{method:"PUT",body:JSON.stringify(list)})).json();

// Función auxiliar para calcular el neto fuera del formulario
function calculateNetoValue(bruto, irpfPerc) {
    const b = parseFloat(bruto) || 0;
    const i = parseFloat(irpfPerc) || 0;
    if (b <= 0) return 0;
    return b - (b * (i / 100));
}


// Cargar cursos y pagadores
async function load(){
  const [data, pagadoresData] = await Promise.all([GET(), GET_COMPANIES()]);
  
  courses = [];
  if(data) {
      for(const k in data) {
          const course = data[k];
          course.importeBruto = course.importeBruto || course.importe; 
          course.importeNeto = calculateNetoValue(course.importeBruto, course.irpf);

          courses.push({key:k, ...course});
      }
  }
  courses.sort((a,b)=> new Date(b.inicio) - new Date(a.inicio));

  masterCompanies = Array.isArray(pagadoresData) ? pagadoresData : [];
  
  // Sincronizar pagadores
  const existingPagadoresInCourses = new Set(courses.map(c => c.empresa || c.pagador).filter(e => e));
  let needsUpdate = false;
  existingPagadoresInCourses.forEach(comp => {
      if (comp && !masterCompanies.includes(comp)) {
          masterCompanies.push(comp);
          needsUpdate = true;
      }
  });

  if (needsUpdate) {
      await PUT_COMPANIES(masterCompanies.sort()); 
  }
  
  updateFilters(); 
  renderStats(); 
  render(); 
}

function updateFilters(){
    const pagadores = masterCompanies.sort();

    // 1. Años de Inicio
    const inicioYears = new Set(courses.map(c => c.inicio ? new Date(c.inicio).getFullYear() : null).filter(y => y));
    const currentYear = filterInicioYear.value;
    filterInicioYear.innerHTML = '<option value="">TODOS</option>' + 
        Array.from(inicioYears).sort((a,b)=>b-a).map(y => 
            `<option value="${y}"${y==currentYear ? ' selected' : ''}>${y}</option>`
        ).join('');
    
    // 2. Pagador para el filtro
    const currentPagadorFilter = filterPagador.value;
    filterPagador.innerHTML = '<option value="">TODAS</option>' + 
        pagadores.map(e => 
            `<option value="${e}"${e==currentPagadorFilter ? ' selected' : ''}>${e}</option>`
        ).join('');
        
    // 3. Pagadores para el Datalist del Formulario Superior
    document.getElementById('pagadoresListForm').innerHTML = pagadores.map(e => `<option value="${e}">`).join('');
}

function renderStats(){
    const selectedYear = filterInicioYear.value; 
    const selectedPagador = filterPagador.value;

    const filteredCourses = courses.filter(c => 
        c.cobrado === "COBRADO" && 
        (selectedYear === "" || (c.inicio && new Date(c.inicio).getFullYear() == selectedYear)) && 
        (selectedPagador === "" || (c.empresa || c.pagador) === selectedPagador) 
    );

    const totalImporte = filteredCourses.reduce((sum, c) => sum + (parseFloat(c.importeNeto) || 0), 0);
    const totalHoras = filteredCourses.reduce((sum, c) => sum + (parseFloat(c.horas) || 0), 0);

    document.getElementById('totalImporte').textContent = `${totalImporte.toFixed(2)} €`;
    document.getElementById('totalHoras').textContent = `${totalHoras.toFixed(2)} h`;
}


// Función principal para renderizar la tabla
function render(){
  if(courses.length===0){ tbody.innerHTML="<tr><td colspan=11 style=\"text-align:center;\">No hay cursos</td></tr>"; return; }
  tbody.innerHTML = courses.map((c,i)=>{
      const statusSpan = c.cobrado==="COBRADO" ? "<span class='status-cobrado'>COBRADO</span>" : "<span class='status-pendiente'>PENDIENTE</span>";
      const pagadorName = c.empresa || c.pagador || "";
      const lugar = c.lugarCelebracion || ""; 
      const importeDisplay = (parseFloat(c.importeNeto) || 0).toFixed(2); 
      const isAlert = c.alerta ? ' alert' : ''; 

      return `
        <tr>
          <td>${i+1}</td>
          <td>${c.inicio||""}</td>
          <td>${c.fin||""}</td>
          <td>${pagadorName}</td> 
          <td>${lugar}</td> 
          <td>${c.horas||""}</td>
          <td>${importeDisplay} €</td> 
          <td>${statusSpan}</td> 
          <td>${c.fechaCobro||""}</td>
          <td>${c.renta||""}</td>
          <td class="action-btns">
            <button class="obs-btn${isAlert}" onclick="showObs('${c.key}')" title="Ver Detalles Adicionales">👁</button>
            <button class="edit-btn" onclick="editCourse('${c.key}')" title="Editar Curso Completo"><i class="fas fa-edit"></i></button>
            <button class="delete-btn" onclick="delCourse('${c.key}')" title="Eliminar"><i class="fas fa-trash"></i></button>
          </td>
        </tr>`;
  }).join("");
}

// --- LÓGICA DE NAVEGACIÓN Y EDICIÓN ---

// Función que abre el formulario superior y carga los datos para edición
window.editCourse = key => {
    const c = courses.find(x => x.key === key);
    if (!c) return;
    
    // 1. Limpiar estado primero (Esto garantiza que el courseKeyInput se ponga en vacío)
    closeFormModal(); 
    
    // 2. Establecer la clave de edición *después* de la limpieza
    editingKey = key; 
    courseKeyInput.value = key; 
    
    // 3. Poblar los campos 
    inicio.value = c.inicio || "";
    fin.value = c.fin || "";
    pagador.value = c.empresa || c.pagador || ""; 
    horas.value = c.horas || "";
    importeBruto.value = (parseFloat(c.importeBruto) || 0).toFixed(2);
    irpf.value = (parseFloat(c.irpf) || 0).toFixed(2);
    cobrado.value = c.cobrado || "PENDIENTE";
    fechaCobro.value = c.fechaCobro || "";
    renta.value = c.renta || "";
    observaciones.value = c.observaciones || "";
    lugarCelebracion.value = c.lugarCelebracion || "";
    horario.value = c.horario || "";
    asistentes.value = c.asistentes || "";
    alerta.checked = c.alerta || false; 

    // 4. CALCULAR NETO Y PRECIOS/HORA
    calculateNeto(); 
    
    // Guardar estado inicial del formulario para la detección de cambios
    initialFormData = getFormData();

    // 5. Actualizar la interfaz del formulario
    document.getElementById('formTitle').textContent = `Editar Curso #${courses.findIndex(x => x.key === key) + 1}`;
    document.getElementById('btnSubmitCourse').textContent = 'Guardar Cambios';
    document.getElementById('btnCancelEdit').style.display = 'inline-block';
    
    // 6. Configurar botones de navegación
    updateNavigationButtons(key);

    // 7. Mostrar el modal
    formModal.classList.add('visible');
};

// Navegación (dir: -1 para Anterior, 1 para Siguiente)
window.navigateCourse = dir => {
    // Usamos courseKeyInput.value para obtener la clave actual (más fiable)
    const currentKey = courseKeyInput.value;
    if (!currentKey) return;

    // Lógica para detectar si hay cambios ANTES de navegar
    const currentData = getFormData();
    
    // Si hay un guardado exitoso y el mensaje está visible, lo cerramos para permitir navegar
    if (isSaveSuccess) {
        closeFormModal(); 
        const currentIndex = courses.findIndex(c => c.key === currentKey);
        const newIndex = currentIndex + dir;
        if (newIndex >= 0 && newIndex < courses.length) {
            const newCourseKey = courses[newIndex].key;
            editCourse(newCourseKey);
        }
        return; 
    }
    
    // Si no hay guardado exitoso activo, comprobamos si hay cambios
    const changed = JSON.stringify(currentData) !== JSON.stringify(initialFormData);
    if (changed) {
         if (!confirm("Hay cambios sin guardar. ¿Moverse a otro curso y perder los cambios?")) {
            return;
        }
    }

    const currentIndex = courses.findIndex(c => c.key === currentKey);
    const newIndex = currentIndex + dir;

    if (newIndex >= 0 && newIndex < courses.length) {
        const newCourseKey = courses[newIndex].key;
        editCourse(newCourseKey);
    }
};


// Habilitar/Deshabilitar botones de navegación
function updateNavigationButtons(currentKey) {
    const currentIndex = courses.findIndex(c => c.key === currentKey);

    // Los botones de navegación solo aparecen en modo edición
    btnPrevCourse.style.display = 'inline-block';
    btnNextCourse.style.display = 'inline-block';
    
    // Deshabilitar si está en el primer/último elemento
    btnPrevCourse.disabled = currentIndex === 0;
    btnNextCourse.disabled = currentIndex === courses.length - 1;
}

// --- MODALES Y EXPORTACIÓN ---

// Modal Observaciones (Muestra también Importe Bruto e IRPF, además del Neto)
function showObs(key){ 
    const c = courses.find(x => x.key === key);
    if (!c) return;

    // Calcular precios por hora para el modal
    const h = parseFloat(c.horas) || 0;
    const bruto = parseFloat(c.importeBruto) || 0;
    const neto = parseFloat(c.importeNeto) || 0;
    const precioHBruto = h > 0 ? (bruto / h).toFixed(2) : "N/A";
    const precioHNeto = h > 0 ? (neto / h).toFixed(2) : "N/A";

    const alertaStatus = c.alerta ? 
        '<p style="color:var(--accent-red); font-weight:700;"><i class="fas fa-exclamation-triangle"></i> ¡ALERTA! Incidencia Marcada</p>' : 
        '<p style="color:var(--accent-green);">Sin incidencias marcadas.</p>';


    const details = `
        ${alertaStatus}
        <hr style="border-top: 1px solid rgba(0,0,0,0.1); margin-top: 15px;">
        <p><strong>Importe Bruto:</strong> ${(parseFloat(c.importeBruto) || 0).toFixed(2)} €</p>
        <p><strong>IRPF Aplicado:</strong> ${(parseFloat(c.irpf) || 0).toFixed(2)} %</p>
        <p><strong>Total Cobrado (Neto):</strong> <strong style="color:var(--accent-green);">${(parseFloat(c.importeNeto) || 0).toFixed(2)} €</strong></p>
        <hr style="border-top: 1px solid rgba(0,0,0,0.1); margin-top: 15px;">
        <p><strong>Precio/Hora (Bruto):</strong> ${precioHBruto} €</p>
        <p><strong>Importe/Hora (Neto):</strong> ${precioHNeto} €</p>
        <hr style="border-top: 1px solid rgba(0,0,0,0.1); margin-top: 15px;">
        <p><strong>Lugar de Celebración:</strong> ${c.lugarCelebracion || 'N/A'}</p>
        <p><strong>Horario:</strong> ${c.horario || 'N/A'}</p>
        <p><strong>Asistentes:</strong> ${c.asistentes || 'N/A'}</p>
        <hr style="border-top: 1px solid rgba(0,0,0,0.1);">
        <p><strong>Observaciones:</strong></p>
        <p style="white-space: pre-wrap; color: #333;">${c.observaciones || 'No hay observaciones.'}</p>
    `;

    const modalContent = document.getElementById('obsModal').querySelector('.modal-content');
    modalContent.innerHTML = `
        <button class="close-modal" onclick="closeObsModal()">X</button>
        <h3>Detalles Adicionales del Curso</h3>
        ${details}
    `;

    document.getElementById('obsModal').style.display="flex"; 
}

function closeObsModal(){ document.getElementById('obsModal').style.display="none"; }
window.showObs = showObs; window.closeObsModal = closeObsModal;


// Exportar a Excel (CSV)
function exportToExcel() {
    const headers = ["ID", "Inicio", "Fin", "Pagador", "Lugar Celebración", "Horas", "Importe Bruto", "IRPF (%)", "Importe Neto Cobrado", "Precio Hora Bruto", "Importe Hora Neto", "Pago", "Detalle Cobro", "Año Renta", "Horario", "Asistentes", "Observaciones", "Alerta"];
    
    const csvData = courses.map((c, index) => {
        const h = parseFloat(c.horas) || 0;
        const bruto = parseFloat(c.importeBruto) || 0;
        const neto = parseFloat(c.importeNeto) || 0;
        const precioHBruto = h > 0 ? (bruto / h).toFixed(2) : 0;
        const precioHNeto = h > 0 ? (neto / h).toFixed(2) : 0;

        return [
            index + 1,
            `"${c.inicio || ''}"`,
            `"${c.fin || ''}"`,
            `"${(c.empresa || c.pagador || '').replace(/"/g, '""')}"`, 
            `"${(c.lugarCelebracion || '').replace(/"/g, '""')}"`, 
            c.horas || 0,
            c.importeBruto || 0,
            c.irpf || 0,
            (parseFloat(c.importeNeto) || 0).toFixed(2), 
            precioHBruto,
            precioHNeto,
            c.cobrado || 'PENDIENTE',
            `"${c.fechaCobro || ''}"`,
            c.renta || '',
            `"${(c.horario || '').replace(/"/g, '""')}"`,
            `"${(c.asistentes || '').replace(/"/g, '""')}"`,
            `"${(c.observaciones || '').replace(/"/g, '""')}"`,
            c.alerta ? 'SI' : 'NO'
        ];
    });

    let csvContent = headers.join(";") + "\n";
    csvData.forEach(row => {
        csvContent += row.join(";") + "\n";
    });

    const blob = new Blob(["\ufeff" + csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.setAttribute('href', url);
    link.setAttribute('download', `Cursos_${new Date().toISOString().slice(0, 10)}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
window.exportToExcel = exportToExcel;

// --- Lógica para Eliminar Pagadores No Usados ---
window.cleanUnusedPagadores = async () => {
    if (!confirm("¿Está seguro de que desea eliminar todos los pagadores que NO están asignados a ningún curso en la tabla?")) {
        return;
    }
    
    const pagadoresUsados = new Set(courses.map(c => c.empresa || c.pagador).filter(e => e));
    
    const pagadoresUsadosArray = Array.from(pagadoresUsados).filter(Boolean); 
    const pagadoresAntiguos = masterCompanies.filter(p => !pagadoresUsadosArray.includes(p));
    
    if (pagadoresAntiguos.length === 0) {
        alert("No se encontraron pagadores en la lista maestra que no estén asignados a ningún curso.");
        return;
    }
    
    masterCompanies = pagadoresUsadosArray.sort();
    await PUT_COMPANIES(masterCompanies); 
    
    alert(`Se han eliminado ${pagadoresAntiguos.length} pagadores antiguos: ${pagadoresAntiguos.join(', ')}.`);
    
    updateFilters(); 
    renderStats(); 
    render(); 
};
window.cleanUnusedPagadores = cleanUnusedPagadores;


// CRUD (Formulario Modal - Añadir y Editar)
form.onsubmit = async e=>{
  e.preventDefault();
  
  // 1. Recalcular y asegurar valores finales del neto y precios/hora
  calculateNeto();
  const importeNeto = parseFloat(importeNetoCobrado.value) || 0;
  
  // 2. Recoger todos los campos
  const obj = {
    inicio:inicio.value, 
    fin:fin.value, 
    empresa:pagador.value, 
    pagador:pagador.value, 
    horas:horas.value, 
    importeBruto:importeBruto.value, 
    irpf:irpf.value,
    importeNeto: importeNeto.toFixed(2), 
    cobrado:cobrado.value, 
    fechaCobro:fechaCobro.value,
    renta:renta.value, 
    observaciones:observaciones.value,
    lugarCelebracion:lugarCelebracion.value,
    horario:horario.value,
    asistentes:asistentes.value,
    alerta:alerta.checked
  };
  
  // 3. Manejar nuevo Pagador
  if (obj.empresa && !masterCompanies.includes(obj.empresa)) {
      masterCompanies.push(obj.empresa);
      await PUT_COMPANIES(masterCompanies.sort());
  }
  
  // CORRECCIÓN CRÍTICA: Obtenemos la clave de edición del campo oculto. Es la fuente más fiable.
  const keyToUpdate = courseKeyInput.value;

  // 4. Guardar datos: Si existe una clave (modificando), ACTUALIZAMOS (PUT), si no, CREAMOS (POST)
  if(keyToUpdate){ 
      // Sincronizamos la variable global (necesaria para la navegación y cancelación)
      editingKey = keyToUpdate; 
      
      await PUT(keyToUpdate, obj); 
      
      // Mostrar feedback de guardado (verde) INMEDIATAMENTE
      displayStatus("¡Se han realizado los cambios con éxito!", "success");
      isSaveSuccess = true; 
      
      // FIX: Pequeño retraso para forzar el renderizado del mensaje
      await new Promise(r => setTimeout(r, 50)); 
      
      // Actualizar la tabla principal y los datos internos (esperamos a que se complete)
      await load(); 
      
      // 5. Actualizar el estado inicial para que coincida con lo que acabamos de guardar
      initialFormData = getFormData();
      
      // REQ: Auto-cierre del modal 2 segundos DESPUÉS de que se haya actualizado la tabla
      if (successTimeout) clearTimeout(successTimeout); 
      successTimeout = setTimeout(closeFormModal, 2000); // 2 segundos antes de cerrar

  }
  else { 
      await POST(obj); 
      closeFormModal(); 
      await load(); // Recargar la tabla tras añadir
  }
};

window.delCourse = async key=>{
  if(confirm("¿Eliminar curso?")){ await DEL(key); load(); }
};

// Exponer funciones globales necesarias
window.delCourse = delCourse;
window.renderStats = renderStats;
window.editCourse = editCourse;

load();
</script>
</body>
</html>