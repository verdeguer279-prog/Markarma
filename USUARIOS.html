<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Buscador · Sistema Seguro</title>
  <style>
    :root {
      --bg-dark: #1a1a2e;
      --card-bg: #282844;
      --text-light: #e9e9f0;
      --accent-blue: #007BFF;
      --accent-gradient: linear-gradient(135deg, #667eea, #764ba2);
      --accent-red: #d32f2f;
      --accent-green: #28a745;
      --google-red: #db4437;
      --admin-gold: #ffd700;
    }
    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg-dark);
      color: var(--text-light);
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    .wrap {
      max-width: 940px;
      margin: 32px auto;
      padding: 0 16px;
      box-sizing: border-box;
    }
    header {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      text-align: center;
    }
    .header-left {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 16px;
        width: 100%;
    }
    .logo-box {
      height: 108px;
      width: 108px;
      background: transparent;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      overflow: hidden;
    }
    .logo-box img { max-height: 96px; max-width: 96px; }
    .title h1 { margin: 0; font-size: clamp(1.4rem, 4vw, 2rem); }
    .title p { margin: 4px 0 0; font-size: clamp(.85rem, 2vw, .95rem); color: #ccc; }
    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      box-sizing: border-box;
    }
    .grid { display: grid; gap: 16px; }
    .field { display: grid; gap: 8px; }
    label { font-size: 0.9rem; color: #aaa; }
    input[type="text"], input[type="password"], textarea, input[type="email"] {
      width: 100%;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--text-light);
      padding: 12px;
      border-radius: 8px;
      box-sizing: border-box;
      transition: all 0.3s ease;
    }
    input[type="text"]:focus, input[type="password"]:focus, textarea:focus, input[type="email"]:focus {
      outline: none;
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.3);
    }
    button {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: transform 0.2s, box-shadow 0.2s;
      box-sizing: border-box;
    }
    .btn-primary {
      background: var(--accent-gradient);
      color: #fff;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(118, 75, 162, 0.5);
    }
    .btn-google {
      background: white;
      color: #333;
      border: 1px solid #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
    }
    .btn-google:hover {
      background: #f1f1f1;
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .btn-ghost {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: var(--text-light);
    }
    .btn-ghost:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    .btn-menu-principal {
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: transform 0.2s, box-shadow 0.2s;
        background: var(--card-bg);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: var(--text-light);
        text-decoration: none;
        display: inline-block;
        white-space: nowrap;
        box-sizing: border-box;
    }
    .btn-menu-principal:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        background: rgba(255, 255, 255, 0.1);
    }
    .btn-logout-red, .btn-delete-red {
      background: var(--accent-red);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .btn-logout-red:hover, .btn-delete-red:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(211, 47, 47, 0.5);
      background: #b71c1c;
    }
    .btn-success {
      background: var(--accent-green);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(40, 167, 69, 0.5);
      background: #1e7e34;
    }
    .btn-admin {
        background: transparent;
        border: 1px solid var(--admin-gold);
        color: var(--admin-gold);
    }
    .btn-admin:hover {
        background: rgba(255, 215, 0, 0.1);
        box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
    }
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 1.5rem;
      box-sizing: border-box;
    }
    th, td {
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 12px;
      text-align: left;
      box-sizing: border-box;
    }
    th {
      background: rgba(255, 255, 255, 0.05);
      white-space: nowrap;
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s, visibility 0.3s;
      z-index: 1000;
    }
    .modal-overlay.open { visibility: visible; opacity: 1; }
    .modal {
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      width: 90%;
      max-width: 450px;
      transform: scale(0.95);
      transition: transform 0.3s ease-out;
    }
    .modal-overlay.open .modal { transform: scale(1); }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.5rem;
      background: rgba(255, 255, 255, 0.05);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px 12px 0 0;
    }
    .close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: #aaa;
      cursor: pointer;
    }
    .modal-body { padding: 1.5rem; }
    .form-fields {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
    }
    .password-fields {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
    }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      padding: 1rem 1.5rem;
      background: rgba(255, 255, 255, 0.05);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 0 0 12px 12px;
    }
    .login-container {
      text-align: center;
      margin-top: 50px;
      padding: 24px;
      border-radius: 12px;
      background: var(--card-bg);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      max-width: 350px;
      margin-left: auto;
      margin-right: auto;
    }
    .login-field {
      display: grid;
      gap: 10px;
      margin-bottom: 15px;
    }
    .alert-icon {
        font-size: 2rem;
        color: var(--accent-red);
        margin-right: 1rem;
    }
    .modal-body.alert-content {
        display: flex;
        align-items: center;
    }
    /* Estilos lista usuarios */
    .user-list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(255,255,255,0.05);
        padding: 10px;
        border-radius: 6px;
        margin-bottom: 8px;
    }
    .btn-small-delete {
        background: var(--accent-red);
        color: white;
        border: none;
        padding: 5px 10px;
        font-size: 0.8rem;
        border-radius: 4px;
    }
    @media (max-width: 600px) {
      .wrap { margin: 16px auto; padding: 0 10px; }
      header { flex-direction: column; text-align: center; }
      .title { margin-top: 10px; }
      .grid { grid-template-columns: 1fr; }
      button { width: 100%; margin-bottom: 8px; }
      .login-container { margin: 2rem auto; }
      table, thead, tbody, th, td, tr {
        display: block;
      }
      thead tr { position: absolute; top: -9999px; left: -9999px; }
      td {
        border: none;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        position: relative;
        padding-left: 50%;
        text-align: right;
      }
      td:before {
        content: attr(data-label);
        position: absolute;
        left: 0;
        width: 50%;
        padding-left: 10px;
        font-weight: bold;
        text-align: left;
      }
      .password-fields {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="header-left">
        <div class="logo-box"><img id="logo" alt="Mi logo de Gad" src="logogad.png" /></div>
        <div class="title">
          <h1>Buscador de contraseñas</h1>
          <p>Puedes buscar por titular, usuario y descripción.</p>
          <small id="userDisplay" style="color: var(--accent-blue);"></small>
        </div>
      </div>
      <a href="index.html" class="btn-menu-principal">MENÚ PRINCIPAL</a>
    </header>

    <div id="app-content" hidden>
        <section class="card grid">
          <div class="field">
            <label for="titular">Titular (buscar)</label>
            <input id="titular" type="text" placeholder="Escriba para filtrar por Titular" list="titularesListBusqueda" />
            <datalist id="titularesListBusqueda"></datalist>
          </div>
          <div class="field">
            <label for="usuario">Usuario (buscar)</label>
            <input id="usuario" type="text" placeholder="Escriba para filtrar por Usuario" />
          </div>
          <div class="field">
            <label for="descripcionBusqueda">Descripción (buscar)</label>
            <input id="descripcionBusqueda" type="text" placeholder="Escriba para filtrar por Descripción" list="descripcionesListBusqueda" />
            <datalist id="descripcionesListBusqueda"></datalist>
          </div>
          <div class="field">
            <label for="resultado">Contraseña</label>
            <input id="resultado" type="text" placeholder="Resultado" readonly />
          </div>
          <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            <button id="btnBuscar" class="btn-primary">Buscar</button>
            <button id="btnLimpiar" class="btn-success">Limpiar</button>
            <button id="btnNuevo" class="btn-primary" hidden>Introduzca nuevos datos</button>
            <button id="btnUsuarios" class="btn-admin" hidden>Gestionar Usuarios</button>
            <button id="btnLogout" class="btn-logout-red">Cerrar sesión</button>
          </div>

          <div id="results" hidden>
            <table>
              <thead>
                <tr>
                    <th>Titular</th>
                    <th>Usuario</th>
                    <th>Descripción</th>
                    <th>Contraseña</th>
                    <th id="thAcciones" hidden>Acciones</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>
        </section>
    </div>

    <div id="login-container">
        <h2>Inicie sesión para continuar</h2>
        <p style="color: #aaa; margin-bottom: 20px;">Utilice su cuenta de Google para acceder.</p>
        
        <button id="btnGoogleLogin" class="btn-google">
             <svg width="18" height="18" viewBox="0 0 18 18">
                <path d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z" fill="#4285F4"></path>
                <path d="M9 18c2.43 0 4.467-.806 5.956-2.18L12.048 13.562c-.806.54-1.836.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332A8.997 8.997 0 0 0 9 18z" fill="#34A853"></path>
                <path d="M3.964 10.71A5.41 5.41 0 0 1 3.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 0 0 0 9c0 1.452.348 2.827.957 4.042l3.007-2.332z" fill="#FBBC05"></path>
                <path d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 0 0 .957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z" fill="#EA4335"></path>
             </svg>
             Iniciar sesión con Google
        </button>
        <p id="loginError" style="color: var(--accent-red); margin-top: 10px;" hidden></p>
    </div>

  </div>

  <div id="dlgNuevo" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <strong id="modalTitle">Introduzca nuevos datos</strong>
        <button id="dlgClose" class="btn-ghost close-btn">✕</button>
      </div>
      <form id="formNuevo">
        <div class="modal-body">
          <div class="form-fields">
            <label for="nuevoTitular">Titular</label>
            <input id="nuevoTitular" name="titular" type="text" required list="titularesList" />
            <datalist id="titularesList"></datalist>

            <label for="nuevoUsuario">Usuario</label>
            <input id="nuevoUsuario" name="usuario" type="text" required />
            
            <label for="nuevaDescripcion">Descripción</label>
            <input id="nuevaDescripcion" name="descripcion" type="text" required list="descripcionesList" />
            <datalist id="descripcionesList"></datalist>

            <div class="password-fields">
              <div class="field">
                <label for="nuevoResultado">Contraseña</label>
                <input id="nuevoResultado" name="resultado" type="text" required />
              </div>
            </div>
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" id="btnEliminarRegistro" class="btn-delete-red" hidden>Eliminar</button>
          <button type="reset" class="btn-success">Limpiar</button>
          <button type="submit" class="btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <div id="dlgUsuariosModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <strong>Gestionar Usuarios Autorizados</strong>
        <button id="dlgUsuariosClose" class="btn-ghost close-btn">✕</button>
      </div>
      <div class="modal-body">
          <div class="field" style="margin-bottom: 20px;">
             <label>Añadir nuevo email (Gmail)</label>
             <div style="display: flex; gap: 10px;">
                <input type="email" id="txtNewUserEmail" placeholder="usuario@gmail.com">
                <button id="btnAddUser" class="btn-success">+</button>
             </div>
          </div>
          <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 15px 0;">
          <div id="usersListContainer">
              </div>
      </div>
    </div>
  </div>

  <div id="dlgMessage" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <strong id="messageTitle"></strong>
      </div>
      <div id="messageBody" class="modal-body">
        <p id="messageText"></p>
      </div>
      <div class="modal-actions">
        <button id="messageOk" class="btn-primary">Aceptar</button>
        <button id="messageCancel" class="btn-ghost" hidden>Cancelar</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD4hCPs_xAHkRroAhk3me5pGnF0Bf81AGw",
      authDomain: "markarma279.firebaseapp.com",
      databaseURL: "https://markarma279-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "markarma279",
      storageBucket: "markarma279.firebasestorage.app",
      messagingSenderId: "280620278315",
      appId: "1:280620278315:web:42adbb1aacb3ac2239806e"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    const googleProvider = new firebase.auth.GoogleAuthProvider();
    
    // --- CONFIGURACIÓN DE SEGURIDAD ---
    // Este es el único ID que tiene permiso de todo
    const ADMIN_UID = "euq9uxFJrAft9m1cNob0PZ1fo7q1"; 
    // Referencia fija a los datos del admin para que se compartan
    const SHARED_DATA_REF = db.ref('passwords/' + ADMIN_UID);
    const ALLOWED_USERS_REF = db.ref('allowed_users');

    const $ = sel => document.querySelector(sel);
    const titular = $("#titular"), usuario = $("#usuario"), descripcionBusqueda = $("#descripcionBusqueda"), resultado = $("#resultado"), tbody = $("#tbody"), results = $("#results");
    const appContent = $("#app-content");
    const loginContainer = $("#login-container");
    const btnGoogleLogin = $("#btnGoogleLogin");
    const btnLogout = $("#btnLogout");
    const btnNuevo = $("#btnNuevo");
    const btnUsuarios = $("#btnUsuarios");
    const userDisplay = $("#userDisplay");
    const loginError = $("#loginError");
    const thAcciones = $("#thAcciones");

    // Gestión Usuarios Modal
    const dlgUsuariosModal = $("#dlgUsuariosModal");
    const dlgUsuariosClose = $("#dlgUsuariosClose");
    const txtNewUserEmail = $("#txtNewUserEmail");
    const btnAddUser = $("#btnAddUser");
    const usersListContainer = $("#usersListContainer");
    
    const dlgMessage = $("#dlgMessage"), messageTitle = $("#messageTitle"), messageText = $("#messageText"), messageBody = $("#messageBody"), messageOk = $("#messageOk"), messageCancel = $("#messageCancel");

    let allUserPasswords = [];
    let isAdmin = false;

    function normalize(s) { return (s || "").toString().trim().toLowerCase(); }

    function showMessage(title, text, isConfirm = false, isAlert = false) {
      return new Promise((resolve) => {
        messageTitle.textContent = title;
        messageText.innerHTML = text;
        messageBody.classList.toggle('alert-content', isAlert);
        messageCancel.hidden = !isConfirm;
        dlgMessage.classList.add("open");

        messageOk.onclick = () => {
          dlgMessage.classList.remove("open");
          resolve(true);
        };
        messageCancel.onclick = () => {
          dlgMessage.classList.remove("open");
          resolve(false);
        };
      });
    }

    // --- LÓGICA DE AUTENTICACIÓN Y ROLES ---
    auth.onAuthStateChanged((user) => {
      if (user) {
        // Verificar permisos
        if (user.uid === ADMIN_UID) {
            // ES EL ADMINISTRADOR
            isAdmin = true;
            initializeSession(user);
        } else {
            // ES UN USUARIO NORMAL, VERIFICAR SI ESTÁ AUTORIZADO
            isAdmin = false;
            checkIfAllowed(user);
        }
      } else {
        // NO LOGUEADO
        appContent.hidden = true;
        loginContainer.hidden = false;
        loginError.hidden = true;
      }
    });

    function checkIfAllowed(user) {
        ALLOWED_USERS_REF.once('value').then(snapshot => {
            const allowed = snapshot.val();
            let isAllowed = false;
            if (allowed) {
                const emails = Object.values(allowed);
                if (emails.includes(user.email)) {
                    isAllowed = true;
                }
            }

            if (isAllowed) {
                initializeSession(user);
            } else {
                auth.signOut();
                loginError.textContent = "Acceso denegado. Este usuario no está autorizado.";
                loginError.hidden = false;
            }
        });
    }

    function initializeSession(user) {
        appContent.hidden = false;
        loginContainer.hidden = true;
        userDisplay.textContent = `Usuario: ${user.email} ${isAdmin ? '(ADMIN)' : '(Invitado)'}`;

        // Configurar UI según rol
        if (isAdmin) {
            btnNuevo.hidden = false;
            btnUsuarios.hidden = false;
            thAcciones.hidden = false;
        } else {
            btnNuevo.hidden = true;
            btnUsuarios.hidden = true;
            thAcciones.hidden = true;
        }

        // Cargar contraseñas (siempre del nodo del admin)
        SHARED_DATA_REF.on('value', (snapshot) => {
            const data = snapshot.val();
            allUserPasswords = [];
            if (data) {
                Object.keys(data).forEach(key => {
                    allUserPasswords.push({ key: key, ...data[key] });
                });
            }
            allUserPasswords.sort((a, b) => {
                const titularA = a.titular || '';
                const titularB = b.titular || '';
                const normalizedA = normalize(titularA);
                const normalizedB = normalize(titularB);
                if (normalizedA === 'rafa') return -1;
                if (normalizedB === 'rafa') return 1;
                return normalizedA.localeCompare(normalizedB);
            });
            doSearch();
            populateDatalists();
        });
    }

    // --- FUNCIONALIDAD GESTIÓN USUARIOS (Solo Admin) ---
    btnUsuarios.onclick = () => {
        loadAllowedUsers();
        dlgUsuariosModal.classList.add("open");
    };
    dlgUsuariosClose.onclick = () => dlgUsuariosModal.classList.remove("open");

    function loadAllowedUsers() {
        usersListContainer.innerHTML = "<p>Cargando...</p>";
        ALLOWED_USERS_REF.on('value', (snapshot) => {
            usersListContainer.innerHTML = "";
            const users = snapshot.val();
            if (users) {
                Object.keys(users).forEach(key => {
                    const email = users[key];
                    const div = document.createElement("div");
                    div.className = "user-list-item";
                    div.innerHTML = `
                        <span>${email}</span>
                        <button class="btn-small-delete" onclick="removeUser('${key}', '${email}')">Eliminar</button>
                    `;
                    usersListContainer.appendChild(div);
                });
            } else {
                usersListContainer.innerHTML = "<p style='color:#aaa'>No hay usuarios extra autorizados.</p>";
            }
        });
    }

    btnAddUser.onclick = () => {
        const email = txtNewUserEmail.value.trim();
        if (email) {
            ALLOWED_USERS_REF.push(email);
            txtNewUserEmail.value = "";
        }
    };

    window.removeUser = async (key, email) => {
        const confirm = await showMessage("Eliminar Usuario", `¿Quitar acceso a <b>${email}</b>?`, true, true);
        if (confirm) {
            ALLOWED_USERS_REF.child(key).remove();
        }
    };

    // --- FUNCIONALIDAD PRINCIPAL ---

    function populateDatalists() {
        const titularesSet = new Set();
        const descripcionesSet = new Set();
        
        allUserPasswords.forEach(item => {
            if (item.titular) titularesSet.add(item.titular);
            if (item.descripcion) descripcionesSet.add(item.descripcion);
        });
        
        const titularesList = $("#titularesList");
        const descripcionesList = $("#descripcionesList");
        const titularesListBusqueda = $("#titularesListBusqueda");
        const descripcionesListBusqueda = $("#descripcionesListBusqueda");

        titularesList.innerHTML = "";
        descripcionesList.innerHTML = "";
        titularesListBusqueda.innerHTML = "";
        descripcionesListBusqueda.innerHTML = "";

        titularesSet.forEach(titular => {
            const option = document.createElement("option");
            option.value = titular;
            titularesList.appendChild(option);
            titularesListBusqueda.appendChild(option.cloneNode(true));
        });

        descripcionesSet.forEach(descripcion => {
            const option = document.createElement("option");
            option.value = descripcion;
            descripcionesList.appendChild(option);
            descripcionesListBusqueda.appendChild(option.cloneNode(true));
        });
    }

    function doSearch() {
        const f1 = normalize(titular.value);
        const f2 = normalize(usuario.value);
        const f3 = normalize(descripcionBusqueda.value);
        
        const matches = allUserPasswords.filter(r =>
            (f1 === "" || normalize(r.titular).includes(f1)) &&
            (f2 === "" || normalize(r.usuario).includes(f2)) &&
            (f3 === "" || normalize(r.descripcion).includes(f3))
        );
        
        tbody.innerHTML = "";
        matches.forEach(r => {
            const tr = document.createElement("tr");
            let accionesHtml = "";
            if (isAdmin) {
                accionesHtml = `<td data-label="Acciones"><button class="btn-primary" onclick="editPassword('${r.key}')">Editar</button></td>`;
            }

            tr.innerHTML = `
                <td data-label="Titular">${r.titular}</td>
                <td data-label="Usuario" data-copiable="true">${r.usuario}</td>
                <td data-label="Descripción">${r.descripcion}</td>
                <td data-label="Contraseña">${r.resultado}</td>
                ${accionesHtml}
            `;
            tr.onclick = () => { resultado.value = r.resultado; };
            tbody.appendChild(tr);
        });
        results.hidden = matches.length === 0;
        if (matches.length === 1) { resultado.value = matches[0].resultado; }
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        const message = document.createElement('div');
        message.textContent = 'Copiado al portapapeles';
        message.style.cssText = `
          position: fixed;
          bottom: 20px; left: 50%; transform: translateX(-50%);
          background: #333; color: white; padding: 10px 20px;
          border-radius: 5px; z-index: 1001; opacity: 0; transition: opacity 0.5s;
        `;
        document.body.appendChild(message);
        setTimeout(() => message.style.opacity = 1, 10);
        setTimeout(() => { message.style.opacity = 0; setTimeout(() => message.remove(), 500); }, 2000);
      });
    }
    
    tbody.addEventListener('contextmenu', (e) => {
      const target = e.target.closest('td[data-copiable="true"]');
      if (target) { e.preventDefault(); copyToClipboard(target.textContent); }
    });
    
    titular.oninput = doSearch;
    usuario.oninput = doSearch;
    descripcionBusqueda.oninput = doSearch;

    $("#btnBuscar").onclick = doSearch;
    $("#btnLimpiar").onclick = () => {
        titular.value = ""; usuario.value = ""; descripcionBusqueda.value = ""; resultado.value = ""; 
        doSearch();
    };

    const dlg = $("#dlgNuevo"), formNuevo = $("#formNuevo"), dlgClose = $("#dlgClose"), modalTitle = $("#modalTitle");
    const btnEliminarRegistro = $("#btnEliminarRegistro");

    $("#btnNuevo").onclick = () => {
      formNuevo.reset();
      modalTitle.textContent = "Introduzca nuevos datos";
      btnEliminarRegistro.hidden = true;
      formNuevo.onsubmit = saveNewPassword;
      dlg.classList.add("open");
    };

    dlgClose.onclick = () => dlg.classList.remove("open");

    function saveNewPassword(e) {
        e.preventDefault();
        const fd = new FormData(formNuevo);
        const nuevo = Object.fromEntries(fd.entries());
        
        SHARED_DATA_REF.push(nuevo).then(() => {
            dlg.classList.remove("open");
        }).catch(error => {
            console.error("Error", error);
            showMessage("Error", "Error al guardar.");
        });
    }
    
    function editPassword(key) {
        if (!isAdmin) return; // Seguridad extra

        const passwordRef = SHARED_DATA_REF.child(key);
        passwordRef.once('value').then(snapshot => {
            const data = snapshot.val();
            
            $("#nuevoTitular").value = data.titular;
            $("#nuevoUsuario").value = data.usuario;
            $("#nuevaDescripcion").value = data.descripcion;
            $("#nuevoResultado").value = data.resultado;
            
            modalTitle.textContent = "Editar datos";
            btnEliminarRegistro.hidden = false;
            
            formNuevo.onsubmit = (e) => {
                e.preventDefault();
                const fd = new FormData(formNuevo);
                const updatedData = Object.fromEntries(fd.entries());
                
                passwordRef.update(updatedData).then(() => {
                    dlg.classList.remove("open");
                    showMessage("Éxito", "Actualizado correctamente.");
                });
            };
            
            btnEliminarRegistro.onclick = async () => {
                const confirmResult = await showMessage("Confirmar", `¿Eliminar registro de **${data.titular}**?`, true, true);
                if (confirmResult) {
                    passwordRef.remove().then(() => {
                        dlg.classList.remove("open");
                    });
                }
            };
            
            dlg.classList.add("open");
        });
    }
    window.editPassword = editPassword;

    btnLogout.onclick = () => {
      auth.signOut().then(() => {
        console.log("Sesión cerrada.");
        loginError.hidden = true;
      });
    };

    btnGoogleLogin.onclick = () => {
        auth.signInWithPopup(googleProvider)
            .catch((error) => {
                console.error("Error login:", error);
                loginError.textContent = error.message;
                loginError.hidden = false;
            });
    };
  </script>
</body>
</html>