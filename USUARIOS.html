<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Buscador · Titular-Usuario-Descripción-Resultado</title>
  <style>
    :root {
      --bg-dark: #1a1a2e;
      --card-bg: #282844;
      --text-light: #e9e9f0;
      --accent-blue: #007BFF;
      --accent-gradient: linear-gradient(135deg, #667eea, #764ba2);
      --accent-red: #d32f2f;
      --accent-green: #28a745;
    }
    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg-dark);
      color: var(--text-light);
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    .wrap {
      max-width: 940px;
      margin: 32px auto;
      padding: 0 16px;
      box-sizing: border-box;
    }
    header {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      text-align: center;
    }
    .header-left {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 16px;
        width: 100%;
    }
    .logo-box {
      height: 108px;
      width: 108px;
      background: transparent;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      overflow: hidden;
    }
    .logo-box img { max-height: 96px; max-width: 96px; }
    .title h1 { margin: 0; font-size: clamp(1.4rem, 4vw, 2rem); }
    .title p { margin: 4px 0 0; font-size: clamp(.85rem, 2vw, .95rem); color: #ccc; }
    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      box-sizing: border-box;
    }
    .grid { display: grid; gap: 16px; }
    .field { display: grid; gap: 8px; }
    label { font-size: 0.9rem; color: #aaa; }
    input[type="text"], input[type="password"], textarea, input[type="email"] {
      width: 100%;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--text-light);
      padding: 12px;
      border-radius: 8px;
      box-sizing: border-box;
      transition: all 0.3s ease;
    }
    input[type="text"]:focus, input[type="password"]:focus, textarea:focus, input[type="email"]:focus {
      outline: none;
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.3);
    }
    button {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: transform 0.2s, box-shadow 0.2s;
      box-sizing: border-box;
    }
    .btn-primary {
      background: var(--accent-gradient);
      color: #fff;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(118, 75, 162, 0.5);
    }
    .btn-ghost {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: var(--text-light);
    }
    .btn-ghost:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    .btn-menu-principal {
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: transform 0.2s, box-shadow 0.2s;
        background: var(--card-bg);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: var(--text-light);
        text-decoration: none;
        display: inline-block;
        white-space: nowrap;
        box-sizing: border-box;
    }
    .btn-menu-principal:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        background: rgba(255, 255, 255, 0.1);
    }
    .btn-logout-red, .btn-delete-red {
      background: var(--accent-red);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .btn-logout-red:hover, .btn-delete-red:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(211, 47, 47, 0.5);
      background: #b71c1c;
    }
    .btn-success {
      background: var(--accent-green);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(40, 167, 69, 0.5);
      background: #1e7e34;
    }
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 1.5rem;
      box-sizing: border-box;
    }
    th, td {
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 12px;
      text-align: left;
      box-sizing: border-box;
    }
    th {
      background: rgba(255, 255, 255, 0.05);
      white-space: nowrap;
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s, visibility 0.3s;
      z-index: 1000;
    }
    .modal-overlay.open { visibility: visible; opacity: 1; }
    .modal {
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      width: 90%;
      max-width: 450px;
      transform: scale(0.95);
      transition: transform 0.3s ease-out;
    }
    .modal-overlay.open .modal { transform: scale(1); }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.5rem;
      background: rgba(255, 255, 255, 0.05);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px 12px 0 0;
    }
    .close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: #aaa;
      cursor: pointer;
    }
    .modal-body { padding: 1.5rem; }
    .form-fields {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
    }
    .password-fields {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
    }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      padding: 1rem 1.5rem;
      background: rgba(255, 255, 255, 0.05);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 0 0 12px 12px;
    }
    .login-container {
      text-align: center;
      margin-top: 50px;
      padding: 24px;
      border-radius: 12px;
      background: var(--card-bg);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      max-width: 350px;
      margin-left: auto;
      margin-right: auto;
    }
    .login-field {
      display: grid;
      gap: 10px;
      margin-bottom: 15px;
    }
    .btn-reset-password {
        background: transparent;
        color: var(--text-light);
        border: none;
        font-size: 0.85rem;
        cursor: pointer;
        padding: 0;
        text-decoration: underline;
    }
    .btn-reset-password:hover {
        color: var(--accent-blue);
    }
    .alert-icon {
        font-size: 2rem;
        color: var(--accent-red);
        margin-right: 1rem;
    }
    .modal-body.alert-content {
        display: flex;
        align-items: center;
    }
    @media (max-width: 600px) {
      .wrap { margin: 16px auto; padding: 0 10px; }
      header { flex-direction: column; text-align: center; }
      .title { margin-top: 10px; }
      .grid { grid-template-columns: 1fr; }
      button { width: 100%; margin-bottom: 8px; }
      .login-container { margin: 2rem auto; }
      table, thead, tbody, th, td, tr {
        display: block;
      }
      thead tr { position: absolute; top: -9999px; left: -9999px; }
      td {
        border: none;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        position: relative;
        padding-left: 50%;
        text-align: right;
      }
      td:before {
        content: attr(data-label);
        position: absolute;
        left: 0;
        width: 50%;
        padding-left: 10px;
        font-weight: bold;
        text-align: left;
      }
      .password-fields {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="header-left">
        <div class="logo-box"><img id="logo" alt="Mi logo de Gad" src="logogad.png" /></div>
        <div class="title">
          <h1>Buscador de contraseñas</h1>
          <p>Puedes buscar por titular, usuario y descripción.</p>
        </div>
      </div>
      <a href="index.html" class="btn-menu-principal">MENÚ PRINCIPAL</a>
    </header>

    <div id="app-content" hidden>
        <section class="card grid">
          <div class="field">
            <label for="titular">Titular (buscar)</label>
            <input id="titular" type="text" placeholder="Escriba para filtrar por Titular" list="titularesListBusqueda" />
            <datalist id="titularesListBusqueda"></datalist>
          </div>
          <div class="field">
            <label for="usuario">Usuario (buscar)</label>
            <input id="usuario" type="text" placeholder="Escriba para filtrar por Usuario" />
          </div>
          <div class="field">
            <label for="descripcionBusqueda">Descripción (buscar)</label>
            <input id="descripcionBusqueda" type="text" placeholder="Escriba para filtrar por Descripción" list="descripcionesListBusqueda" />
            <datalist id="descripcionesListBusqueda"></datalist>
          </div>
          <div class="field">
            <label for="resultado">Contraseña 1</label>
            <input id="resultado" type="text" placeholder="Resultado" readonly />
          </div>
          <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            <button id="btnBuscar" class="btn-primary">Buscar</button>
            <button id="btnLimpiar" class="btn-success">Limpiar</button>
            <button id="btnNuevo" class="btn-primary">Introduzca nuevos datos</button>
            <button id="btnLogout" class="btn-logout-red">Cerrar sesión</button>
          </div>

          <div id="results" hidden>
            <table>
              <thead>
                <tr>
                    <th>Titular</th>
                    <th>Usuario</th>
                    <th>Descripción</th>
                    <th>Contraseña</th>
                    <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>
        </section>
    </div>

    <div id="login-container">
        <h2>Inicie sesión para continuar</h2>
        <div class="login-field">
            <label for="loginEmail">Correo electrónico</label>
            <input id="loginEmail" type="email" placeholder="email@ejemplo.com" required />
        </div>
        <div class="login-field">
            <label for="loginPassword">Contraseña</label>
            <input id="loginPassword" type="password" required />
        </div>
        <div style="display: flex; justify-content: space-between; gap: 10px; margin-top: 15px;">
            <button id="btnSignIn" class="btn-primary" style="flex-grow: 1;">Iniciar sesión</button>
            <button id="btnResetPassword" class="btn-ghost" style="flex-grow: 1;">¿Olvidó su contraseña?</button>
        </div>
    </div>

  </div>

  <div id="dlgNuevo" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <strong id="modalTitle">Introduzca nuevos datos</strong>
        <button id="dlgClose" class="btn-ghost close-btn">✕</button>
      </div>
      <form id="formNuevo">
        <div class="modal-body">
          <div class="form-fields">
            <label for="nuevoTitular">Titular</label>
            <input id="nuevoTitular" name="titular" type="text" required list="titularesList" />
            <datalist id="titularesList"></datalist>

            <label for="nuevoUsuario">Usuario</label>
            <input id="nuevoUsuario" name="usuario" type="text" required />
            
            <label for="nuevaDescripcion">Descripción</label>
            <input id="nuevaDescripcion" name="descripcion" type="text" required list="descripcionesList" />
            <datalist id="descripcionesList"></datalist>

            <div class="password-fields">
              <div class="field">
                <label for="nuevoResultado">Contraseña</label>
                <input id="nuevoResultado" name="resultado" type="text" required />
              </div>
            </div>
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" id="btnEliminarRegistro" class="btn-delete-red" hidden>Eliminar registro</button>
          <button type="reset" class="btn-success">Limpiar</button>
          <button type="submit" class="btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <div id="dlgMessage" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <strong id="messageTitle"></strong>
      </div>
      <div id="messageBody" class="modal-body">
        <p id="messageText"></p>
      </div>
      <div class="modal-actions">
        <button id="messageOk" class="btn-primary">Aceptar</button>
        <button id="messageCancel" class="btn-ghost" hidden>Cancelar</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD4hCPs_xAHkRroAhk3me5pGnF0Bf81AGw",
      authDomain: "markarma279.firebaseapp.com",
      databaseURL: "https://markarma279-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "markarma279",
      storageBucket: "markarma279.firebasestorage.app",
      messagingSenderId: "280620278315",
      appId: "1:280620278315:web:42adbb1aacb3ac2239806e"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    
    const $ = sel => document.querySelector(sel);
    const titular = $("#titular"), usuario = $("#usuario"), descripcionBusqueda = $("#descripcionBusqueda"), resultado = $("#resultado"), tbody = $("#tbody"), results = $("#results");
    const appContent = $("#app-content");
    const loginContainer = $("#login-container");
    const loginEmail = $("#loginEmail"), loginPassword = $("#loginPassword");
    const btnSignIn = $("#btnSignIn");
    const btnResetPassword = $("#btnResetPassword");
    const btnLogout = $("#btnLogout");
    
    const dlgMessage = $("#dlgMessage"), messageTitle = $("#messageTitle"), messageText = $("#messageText"), messageBody = $("#messageBody"), messageOk = $("#messageOk"), messageCancel = $("#messageCancel");

    loginEmail.value = localStorage.getItem('lastLoginEmail') || '';
    
    let allUserPasswords = [];

    function normalize(s) { return (s || "").toString().trim().toLowerCase(); }

    function showMessage(title, text, isConfirm = false, isAlert = false) {
      return new Promise((resolve) => {
        messageTitle.textContent = title;
        messageText.innerHTML = text;
        messageBody.classList.toggle('alert-content', isAlert);
        messageCancel.hidden = !isConfirm;
        dlgMessage.classList.add("open");

        messageOk.onclick = () => {
          dlgMessage.classList.remove("open");
          resolve(true);
        };
        messageCancel.onclick = () => {
          dlgMessage.classList.remove("open");
          resolve(false);
        };
      });
    }

    auth.onAuthStateChanged((user) => {
      if (user) {
        appContent.hidden = false;
        loginContainer.hidden = true;
        
        localStorage.setItem('lastLoginEmail', user.email);

        const userPasswordsRef = db.ref('passwords/' + user.uid);

        userPasswordsRef.on('value', (snapshot) => {
            const data = snapshot.val();
            allUserPasswords = [];
            if (data) {
                Object.keys(data).forEach(key => {
                    allUserPasswords.push({ key: key, ...data[key] });
                });
            }
            allUserPasswords.sort((a, b) => {
                const titularA = a.titular || '';
                const titularB = b.titular || '';
                const normalizedA = normalize(titularA);
                const normalizedB = normalize(titularB);

                if (normalizedA === 'rafa') return -1;
                if (normalizedB === 'rafa') return 1;

                return normalizedA.localeCompare(normalizedB);
            });
            doSearch();
            populateDatalists();
        });

        function populateDatalists() {
            const titularesSet = new Set();
            const descripcionesSet = new Set();
            
            allUserPasswords.forEach(item => {
                if (item.titular) titularesSet.add(item.titular);
                if (item.descripcion) descripcionesSet.add(item.descripcion);
            });
            
            const titularesList = $("#titularesList");
            const descripcionesList = $("#descripcionesList");
            const titularesListBusqueda = $("#titularesListBusqueda");
            const descripcionesListBusqueda = $("#descripcionesListBusqueda");

            titularesList.innerHTML = "";
            descripcionesList.innerHTML = "";
            titularesListBusqueda.innerHTML = "";
            descripcionesListBusqueda.innerHTML = "";

            titularesSet.forEach(titular => {
                const option = document.createElement("option");
                option.value = titular;
                titularesList.appendChild(option);
                titularesListBusqueda.appendChild(option.cloneNode(true));
            });

            descripcionesSet.forEach(descripcion => {
                const option = document.createElement("option");
                option.value = descripcion;
                descripcionesList.appendChild(option);
                descripcionesListBusqueda.appendChild(option.cloneNode(true));
            });
        }

        function doSearch() {
            const f1 = normalize(titular.value);
            const f2 = normalize(usuario.value);
            const f3 = normalize(descripcionBusqueda.value);
            
            const matches = allUserPasswords.filter(r =>
                (f1 === "" || normalize(r.titular).includes(f1)) &&
                (f2 === "" || normalize(r.usuario).includes(f2)) &&
                (f3 === "" || normalize(r.descripcion).includes(f3))
            );
            
            tbody.innerHTML = "";
            matches.forEach(r => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td data-label="Titular">${r.titular}</td>
                    <td data-label="Usuario" data-copiable="true">${r.usuario}</td>
                    <td data-label="Descripción">${r.descripcion}</td>
                    <td data-label="Contraseña">${r.resultado}</td>
                    <td data-label="Acciones">
                        <button class="btn-primary" onclick="editPassword('${r.key}')">Editar</button>
                    </td>
                `;
                tr.onclick = () => { resultado.value = r.resultado; };
                tbody.appendChild(tr);
            });
            results.hidden = matches.length === 0;
            if (matches.length === 1) { resultado.value = matches[0].resultado; }
        }

        function copyToClipboard(text) {
          navigator.clipboard.writeText(text).then(() => {
            const message = document.createElement('div');
            message.textContent = 'Copiado al portapapeles';
            message.style.cssText = `
              position: fixed;
              bottom: 20px;
              left: 50%;
              transform: translateX(-50%);
              background: #333;
              color: white;
              padding: 10px 20px;
              border-radius: 5px;
              z-index: 1001;
              opacity: 0;
              transition: opacity 0.5s ease-in-out;
            `;
            document.body.appendChild(message);
            setTimeout(() => {
              message.style.opacity = 1;
            }, 10);
            setTimeout(() => {
              message.style.opacity = 0;
              setTimeout(() => message.remove(), 500);
            }, 2000);
          }).catch(err => {
            console.error('Error al copiar el texto: ', err);
          });
        }
        
        tbody.addEventListener('contextmenu', (e) => {
          const target = e.target.closest('td[data-copiable="true"]');
          if (target) {
            e.preventDefault();
            copyToClipboard(target.textContent);
          }
        });
        
        titular.oninput = doSearch;
        usuario.oninput = doSearch;
        descripcionBusqueda.oninput = doSearch;

        $("#btnBuscar").onclick = doSearch;
        
        $("#btnLimpiar").onclick = () => {
            titular.value = ""; 
            usuario.value = ""; 
            descripcionBusqueda.value = ""; 
            resultado.value = ""; 
            doSearch();
        };

        const dlg = $("#dlgNuevo"), formNuevo = $("#formNuevo"), dlgClose = $("#dlgClose"), modalTitle = $("#modalTitle");
        const btnEliminarRegistro = $("#btnEliminarRegistro");

        $("#btnNuevo").onclick = () => {
          formNuevo.reset();
          modalTitle.textContent = "Introduzca nuevos datos";
          btnEliminarRegistro.hidden = true;
          formNuevo.onsubmit = saveNewPassword;
          dlg.classList.add("open");
        };

        dlgClose.onclick = () => dlg.classList.remove("open");

        function saveNewPassword(e) {
            e.preventDefault();
            const fd = new FormData(formNuevo);
            const nuevo = Object.fromEntries(fd.entries());
            
            userPasswordsRef.push(nuevo).then(() => {
                dlg.classList.remove("open");
            }).catch(error => {
                console.error("Error al guardar los datos: ", error);
                showMessage("Error", "Hubo un error al guardar los datos.");
            });
        }
        
        function editPassword(key) {
            const passwordRef = db.ref('passwords/' + user.uid + '/' + key);
            passwordRef.once('value').then(snapshot => {
                const data = snapshot.val();
                
                $("#nuevoTitular").value = data.titular;
                $("#nuevoUsuario").value = data.usuario;
                $("#nuevaDescripcion").value = data.descripcion;
                $("#nuevoResultado").value = data.resultado;
                
                modalTitle.textContent = "Editar datos";
                btnEliminarRegistro.hidden = false;
                
                formNuevo.onsubmit = (e) => {
                    e.preventDefault();
                    const fd = new FormData(formNuevo);
                    const updatedData = Object.fromEntries(fd.entries());
                    
                    passwordRef.update(updatedData).then(() => {
                        dlg.classList.remove("open");
                        showMessage("Éxito", "Los datos se han actualizado correctamente.");
                    }).catch(error => {
                        console.error("Error al actualizar los datos: ", error);
                        showMessage("Error", "Hubo un error al actualizar los datos.");
                    });
                };
                
                btnEliminarRegistro.onclick = async () => {
                    const alertIcon = '<div class="alert-icon">❌</div>';
                    const confirmResult = await showMessage("Confirmar eliminación", `${alertIcon} ¿Estás seguro de que quieres eliminar el registro para **${data.titular}**? Esta acción no se puede deshacer.`, true, true);
                    if (confirmResult) {
                        passwordRef.remove().then(() => {
                            dlg.classList.remove("open");
                            showMessage("Registro eliminado", "El registro se ha eliminado correctamente.");
                        }).catch(error => {
                            console.error("Error al eliminar el registro: ", error);
                            showMessage("Error", "Hubo un error al intentar eliminar el registro.");
                        });
                    }
                };
                
                dlg.classList.add("open");
            });
        }
        window.editPassword = editPassword;


        btnLogout.onclick = () => {
          auth.signOut().then(() => {
            console.log("Sesión cerrada correctamente.");
            loginPassword.value = "";
          }).catch((error) => {
            console.error("Error al cerrar sesión:", error);
            showMessage("Error", "Hubo un problema al intentar cerrar la sesión.");
          });
        };
      } else {
        appContent.hidden = true;
        loginContainer.hidden = false;
      }
    });

    btnSignIn.onclick = () => {
        const email = loginEmail.value;
        const password = loginPassword.value;
        auth.signInWithEmailAndPassword(email, password).catch((error) => {
            console.error("Error al iniciar sesión:", error);
            showMessage("Error de Autenticación", "Usuario o contraseña inválidos.");
        });
    };

    btnResetPassword.onclick = () => {
        const email = loginEmail.value;
        if (email) {
            auth.sendPasswordResetEmail(email)
                .then(() => {
                    showMessage("Correo enviado", "Se ha enviado un correo de restablecimiento de contraseña a tu dirección. Por favor, revisa tu bandeja de entrada.");
                })
                .catch((error) => {
                console.error("Error al enviar el correo:", error);
                    showMessage("Error", "No se pudo enviar el correo de restablecimiento. Asegúrate de que el correo electrónico sea correcto y que la cuenta exista.");
                });
        } else {
            showMessage("Atención", "Por favor, introduce tu correo electrónico para restablecer la contraseña.");
        }
    };
  </script>
</body>
</html>